# global block
{
  email ${Cert_Email}
}

# snippet block
() {

}

# site block
Domain {

}

# reverse_proxy for nginx in site conf
location /xray {
  proxy_pass                       http://127.0.0.1:2086;
  proxy_redirect                   off;
  proxy_http_version               1.1;
  proxy_set_header Upgrade         $http_upgrade;
  proxy_set_header Connection      "upgrade";
  proxy_set_header Host            $http_host;
  proxy_set_header X-Real-IP       $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}

# in nginx conf between even and http block
stream {
  map $ssl_preread_server_name $name {
    x.example.com xray;
  }
  upstream xray {
    server 127.0.0.1:2095; # xray xtls伪装站点
  }
  upstream xtls {
    server 127.0.0.1:2096; # Xray端口
  }

  server {
    listen 443 reuseport;
    listen [::]:443 reuseport;
    proxy_pass $name;
    ssl_preread on;
    proxy_protocol on;
  }
  server {
    # Xray XTLS
    listen 127.0.0.1:2095 proxy_protocol;
    proxy_pass xtls;
  }
}

# ===================================
# 伪装和业务站点
http {
  set_real_ip_from 127.0.0.1; # 获取真实客户IP，不然全是127.0.0.1
  real_ip_header proxy_protocol;
  port_in_redirect off; # 重定向去掉端口号

  fastcgi_connect_timeout 300;
  fastcgi_send_timeout 300;
  fastcgi_read_timeout 300;
  fastcgi_buffer_size 64k;
  fastcgi_buffers 4 64k;
  fastcgi_busy_buffers_size 128k;
  fastcgi_temp_file_write_size 256k;

  server {
      listen 80;
      server_name x.example.com;
      return 301 https://x.example.com$request_uri;
  }

  server {
    # 伪装站点由Xray处理SSL
    listen 127.0.0.1:6001 proxy_protocol; # xray http/1.1
    listen 127.0.0.1:6002 proxy_protocol http2; # xray http/2

    server_name x.example.com;
    index index.html index.htm index.php;
    root /home/wwwroot/default;
  }

  server {
    listen 80;
    server_name example.com;
    return 301 https://example.com$request_uri;
  }

  server {
    listen 127.0.0.1:6003 proxy_protocol ssl http2;

    server_name example.com;
    root /home/wwwroot/example.com;
    index index.html index.htm index.php;

    ssl_certificate /etc/ssl/nginx/example.com.pem;
    ssl_certificate_key /etc/ssl/nginx/example.com.key;

    include enable-php-pathinfo.conf;

    location ~ \.php$ {
      # fastcgi_pass unix:/var/run/php/php7.0-fpm.sock;
      fastcgi_pass 127.0.0.1:9000;
      # fastcgi_index index.php;
      fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
      include fastcgi_params;
    }
  }
}

https://crackair.gitbook.io/xrayr-project/za-xiang/nginx+trojan-zan-shi-di-shen
https://www.orzlee.com/proxy/2021/04/13/nginx-sni-offload-port-multiplexing-uses-xray-vless-xtls.html/comment-page-1
# ===================================
# nginx default config
user  www www;
worker_processes auto;
error_log  /www/wwwlogs/nginx_error.log  crit;
pid        /www/server/nginx/logs/nginx.pid;
worker_rlimit_nofile 51200;

events {
  use epoll;
  worker_connections 51200;
  multi_accept on;
}

http {
  include       mime.types;
  #include luawaf.conf;

  include proxy.conf;

  default_type  application/octet-stream;

  server_names_hash_bucket_size 512;
  client_header_buffer_size 32k;
  large_client_header_buffers 4 32k;
  client_max_body_size 50m;

  sendfile   on;
  tcp_nopush on;

  keepalive_timeout 60;

  tcp_nodelay on;

  fastcgi_connect_timeout 300;
  fastcgi_send_timeout 300;
  fastcgi_read_timeout 300;
  fastcgi_buffer_size 64k;
  fastcgi_buffers 4 64k;
  fastcgi_busy_buffers_size 128k;
  fastcgi_temp_file_write_size 256k;
  fastcgi_intercept_errors on;

  gzip on;
  gzip_min_length  1k;
  gzip_buffers     4 16k;
  gzip_http_version 1.1;
  gzip_comp_level 2;
  gzip_types     text/plain application/javascript application/x-javascript text/javascript text/css application/xml;
  gzip_vary on;
  gzip_proxied   expired no-cache no-store private auth;
  gzip_disable   "MSIE [1-6]\.";

  limit_conn_zone $binary_remote_addr zone=perip:10m;
  limit_conn_zone $server_name zone=perserver:10m;

  server_tokens off;
  access_log off;

  server {
    listen 8901;

    server_name phpmyadmin;
    index index.html index.htm index.php;
    root  /www/server/phpmyadmin;
    location ~ /tmp/ {
      return 403;
    }

    #error_page   404   /404.html;
    include enable-php.conf;

    location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$
    {
      expires      30d;
    }

    location ~ .*\.(js|css)?$
    {
      expires      12h;
    }

    location ~ /\.
    {
      deny all;
    }

    access_log  /www/wwwlogs/access.log;
  }
  include /www/server/panel/vhost/nginx/*.conf;
}
